@page "/media/rodzaje-mediow"

@using System
@using System.Collections.Generic
@using System.Threading.Tasks
@using MudBlazor
@using MudBlazor.Services
@using CastlePlus2.Contracts.DTOs.Media
@using CastlePlus2.Client.Services.Media

@inject IRodzajeMediowService Service
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudText Typo="Typo.h5" Class="mb-3">Słownik: Rodzaje Mediów</MudText>

<MudPaper Class="pa-3">
    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="mb-3">
        <MudTextField @bind-Value="_search"
                      Placeholder="Szukaj po kodzie/nazwie..."
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Immediate="true" />
        <MudSpacer />
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick="OpenCreate">
            Dodaj
        </MudButton>
    </MudStack>

    <MudTable Items="_items"
              Hover="true"
              Dense="true"
              Loading="_loading"
              Filter="FilterFunc">
        <HeaderContent>
            <MudTh>Kod</MudTh>
            <MudTh>Nazwa</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Kod">@context.KodRodzaju</MudTd>
            <MudTd DataLabel="Nazwa">@context.Nazwa</MudTd>
            <MudTd DataLabel="Akcje" Class="text-right">
                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                               Size="Size.Small"
                               OnClick="@(() => OpenEdit(context))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                               Size="Size.Small"
                               Color="Color.Error"
                               OnClick="@(() => ConfirmDelete(context))" />
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudPaper>

@code {
    private List<RodzajMediumDto> _items = new();
    private bool _loading;
    private string _search = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load()
    {
        _loading = true;
        try
        {
            _items = await Service.GetAllAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Błąd pobierania: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private bool FilterFunc(RodzajMediumDto item)
    {
        if (string.IsNullOrWhiteSpace(_search)) return true;

        return (item.KodRodzaju?.Contains(_search, StringComparison.OrdinalIgnoreCase) ?? false)
            || (item.Nazwa?.Contains(_search, StringComparison.OrdinalIgnoreCase) ?? false);
    }

    private async Task OpenCreate()
    {
        var dialogRef = await DialogService.ShowAsync<RodzajMediumDialog>(
            "Dodaj rodzaj medium",
            new DialogParameters
            {
                ["Mode"] = RodzajMediumDialogMode.Create,
                ["Existing"] = null
            });

        var result = await dialogRef.Result;
        if (result is not null && !result.Canceled)
            await Load();
    }

    private async Task OpenEdit(RodzajMediumDto existing)
    {
        var dialogRef = await DialogService.ShowAsync<RodzajMediumDialog>(
            "Edytuj rodzaj medium",
            new DialogParameters
            {
                ["Mode"] = RodzajMediumDialogMode.Edit,
                ["Existing"] = existing
            });

        var result = await dialogRef.Result;
        if (result is not null && !result.Canceled)
            await Load();
    }

    private async Task ConfirmDelete(RodzajMediumDto item)
    {
        bool? ok = await DialogService.ShowMessageBox(
            "Usuń",
            $"Czy na pewno usunąć '{item.KodRodzaju}'?",
            yesText: "Usuń",
            cancelText: "Anuluj");

        if (ok != true) return;

        try
        {
            var deleted = await Service.DeleteAsync(item.KodRodzaju);
            if (!deleted)
            {
                Snackbar.Add("Nie znaleziono rekordu do usunięcia.", Severity.Warning);
                return;
            }

            Snackbar.Add("Usunięto.", Severity.Success);
            await Load();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Błąd usuwania: {ex.Message}", Severity.Error);
        }
    }
}
